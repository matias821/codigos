#! /bin/bash
#Ejecutar antimalware para cada usuario del sistema
clear
ls /var/cpanel/users/ > usuarios2.txt
cat /dev/null > log_malware.txt

desde=`cat malware_ultimo.txt`
cantidad=5
hasta=$((desde + cantidad + 1))
fecha=`date '+%Y-%m-%d %H:%M:%S'`

cont=0
for linea in `cat usuarios2.txt`
do
  cont=$((cont+1))
  infectados=0
  archivos_infectados=""
  
  if [ "$cont" -gt "$desde" ]; then
    if [ "$cont" -lt "$hasta" ]; then
       echo "$linea $cont"
       ./malware.expert.scanner.sh scan /home?/"$linea"/public_html/ > log_malware.txt

       infectados=$( echo `cat log_malware.txt | grep -i "Infected files:" | cut -d ":" -f 2`)
       if [ "$infectados" -gt 0 ]; then
          archivos_infectados=$( echo `cat log_malware.txt | grep -i "^/"`)
       fi
       #touch /home3/topadmin/antimalware/"$linea".log
       echo -e "$infectados | $fecha | $archivos_infectados" > /home3/topadmin/public_html/antimalware/"$linea".log
       chown topadmin:topadmin /home3/topadmin/public_html/antimalware/"$linea".log       

       guardar_ultimo=$cont  
        
       horaAhora=`date '+%H'`  
       #echo "$horaAhora"
       if [ "$horaAhora" -gt "10"  ]; then
          break
       fi

    fi	
  fi
done

if [ "$guardar_ultimo" = "$cont" ]; then
  guardar_ultimo=0
fi
guardar_ultimo=28
echo "$guardar_ultimo" > malware_ultimo.txt
